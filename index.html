<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#070A12" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Turnos">

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <title>Barber Turnos</title>

  <style>
    :root{
      color-scheme: dark;

      --bg0:#070A12;
      --bg1:#0B1020;
      --card: rgba(18, 26, 45, .62);
      --card2: rgba(12, 18, 33, .70);

      --text:#EAF0FF;
      --muted:#A4B3D6;

      --stroke: rgba(160, 195, 255, .16);
      --stroke2: rgba(255,255,255,.06);

      --shadow0: 0 14px 40px rgba(0,0,0,.55);
      --shadow1: 0 8px 22px rgba(0,0,0,.45);
      --shadowIn: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.35);

      --blue:#4EA6FF;
      --red:#FF4E6A;
      --amber:#FFD45A;
      --violet:#B48CFF;
      --green:#5CF56F;

      --r14: 14px;
      --r18: 18px;
      --r999: 999px;
    }

    *{ box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(78,166,255,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(180,140,255,.20), transparent 55%),
        radial-gradient(900px 700px at 40% 115%, rgba(92,245,111,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height: 100vh;
    }

    .wrap{ padding: 16px; max-width: 980px; margin: 0 auto; }
    h1{
      margin: 0 0 12px;
      font-size: 18px;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
    }

    .row{ display:flex; gap:12px; flex-wrap: wrap; }

    .card{
      position: relative;
      flex: 1 1 280px;
      border-radius: var(--r18);
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      background-color: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow0);
      backdrop-filter: blur(12px);
      overflow: hidden;
    }
    .card::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(700px 250px at 20% 0%, rgba(78,166,255,.14), transparent 60%),
                  radial-gradient(700px 250px at 80% 0%, rgba(180,140,255,.12), transparent 60%);
      pointer-events:none;
      opacity:.55;
    }
    .card > *{ position:relative; z-index:1; }

    h2{
      margin: 0 0 8px;
      color: rgba(234,240,255,.82);
      font-size: 13px;
      font-weight: 700;
      letter-spacing:.25px;
      text-transform: none;
    }

    .big{
      font-size: 30px;
      font-weight: 900;
      letter-spacing: -0.03em;
      line-height: 1.05;
      text-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    .muted{ color: var(--muted); font-size: 12px; }
    .divider{ height:1px; background: rgba(160,195,255,.14); margin: 12px 0; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: var(--r999);
      border:1px solid rgba(160,195,255,.18);
      background: rgba(10,15,28,.55);
      box-shadow: var(--shadowIn);
      font-size: 12px;
      backdrop-filter: blur(10px);
    }
    .dot{ width:10px; height:10px; border-radius: var(--r999); display:inline-block; box-shadow: 0 0 18px rgba(92,245,111,.38); }

    /* Inputs */
    input[type="time"], input[type="number"], input[type="text"], select{
      width: 100%;
      background: rgba(8,12,22,.65);
      border: 1px solid rgba(160,195,255,.18);
      color: var(--text);
      border-radius: var(--r14);
      padding: 11px 12px;
      font-size: 14px;
      box-shadow: var(--shadowIn);
      outline: none;
    }
    input::placeholder{ color: rgba(164,179,214,.7); }
    input:focus, select:focus{
      border-color: rgba(78,166,255,.55);
      box-shadow: 0 0 0 3px rgba(78,166,255,.18), var(--shadowIn);
    }

    /* List */
    .list{ display:flex; flex-direction: column; gap:10px; }
    .item{
      display:flex; justify-content: space-between; gap: 10px;
      padding: 12px;
      border-radius: var(--r14);
      background: rgba(8,12,22,.55);
      border: 1px solid rgba(160,195,255,.14);
      box-shadow: var(--shadow1), var(--shadowIn);
      backdrop-filter: blur(10px);
    }
    .item strong{ font-size: 14px; }
    .item .meta{ display:flex; flex-direction: column; gap: 6px; align-items: flex-end; text-align: right; }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .right{ display:flex; gap:10px; justify-content:flex-end; flex-wrap: wrap; }
    .tiny{ font-size: 11px; color: rgba(234,240,255,.68); }

    /* Neon buttons */
    button{
      border: 0;
      border-radius: var(--r14);
      padding: 14px 16px;
      font-weight: 900;
      font-size: 16px;
      cursor:pointer;
      user-select: none;
      position: relative;
      transform: translateZ(0);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btnBase{
      background: rgba(8,12,22,.72);
      color: var(--text);
      border: 1px solid rgba(160,195,255,.16);
      box-shadow: 0 10px 22px rgba(0,0,0,.46), var(--shadowIn);
      overflow:hidden;
    }
    .btnBase::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(280px 120px at 30% 0%, rgba(255,255,255,.10), transparent 60%);
      opacity:.75;
      pointer-events:none;
    }
    .btnBase::after{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--r14);
      box-shadow: 0 0 0 1px rgba(255,255,255,.05);
      pointer-events:none;
    }

    /* Neon ring glow per variant */
    .btnPrimary{ --g: var(--blue); }
    .btnDanger{ --g: var(--red); }
    .btnWarn{ --g: var(--amber); }
    .btnViolet{ --g: var(--violet); }
    .btnOk{ --g: var(--green); }

    .btnPrimary, .btnDanger, .btnWarn, .btnViolet, .btnOk{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      background-color: rgba(8,12,22,.72);
      border: 1px solid rgba(160,195,255,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.52), 0 0 0 1px rgba(255,255,255,.04), var(--shadowIn);
    }
    .btnPrimary::after, .btnDanger::after, .btnWarn::after, .btnViolet::after, .btnOk::after{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--r14);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06),
        0 0 18px color-mix(in oklab, var(--g) 45%, transparent),
        0 0 48px color-mix(in oklab, var(--g) 18%, transparent);
      pointer-events:none;
      opacity:.9;
    }

    /* Press + pulse */
    button:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }
    button:focus{ outline:none; }

    .btnSmall{ padding: 10px 12px; font-size: 14px; border-radius: 12px; }
    .btnSmall::after{ border-radius: 12px; }

    /* Touch ripple-ish pulse */
    @keyframes pulse {
      0% { transform: scale(0.85); opacity: .85; }
      100% { transform: scale(1.25); opacity: 0; }
    }
    .pulse{
      position:absolute; inset:0;
      display:block;
      pointer-events:none;
    }
    .pulse::after{
      content:"";
      position:absolute;
      left: 50%; top: 50%;
      width: 10px; height: 10px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      background: color-mix(in oklab, var(--g) 55%, transparent);
      box-shadow: 0 0 24px color-mix(in oklab, var(--g) 60%, transparent);
      animation: pulse .45s ease-out;
    }

    /* Banners */
    .banner{
      padding: 12px;
      border-radius: var(--r14);
      border: 1px solid rgba(160,195,255,.18);
      background: rgba(8,12,22,.62);
      box-shadow: var(--shadow1), var(--shadowIn);
      display:none;
      margin-top: 10px;
      position: relative;
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .banner::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(680px 180px at 10% 0%, rgba(78,166,255,.16), transparent 60%),
                  radial-gradient(680px 180px at 90% 0%, rgba(180,140,255,.12), transparent 60%);
      opacity:.85;
      pointer-events:none;
    }
    .banner strong{ font-size: 13px; position:relative; z-index:1; }
    .banner .muted{ position:relative; z-index:1; display:block; margin-top:4px; }

    dialog::backdrop{ background: rgba(0,0,0,.62); }
    dialog{ border:0; padding:0; background: transparent; }
    .sheet{
      background: rgba(8,12,22,.92);
      border:1px solid rgba(160,195,255,.20);
      border-radius: var(--r18);
      padding: 14px;
      max-width: 560px;
      box-shadow: var(--shadow0);
      backdrop-filter: blur(14px);
    }
    .sheet h2{ margin:0 0 10px; }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
      font-size: 11px; padding: 2px 6px;
      border:1px solid rgba(160,195,255,.22);
      border-radius: 10px;
      background: rgba(8,12,22,.7);
      color: rgba(234,240,255,.82);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>
      <span>Barber Turnos</span>
      <span class="sub">Dark Neon · PWA</span>
    </h1>

    <datalist id="nameSuggestions"></datalist>

    <div class="row">
      <div class="card">
        <h2>Estado</h2>
        <div class="row" style="align-items:center; justify-content: space-between;">
          <div>
            <div class="muted">Ahora</div>
            <div class="big" id="now">--:--</div>
          </div>
          <div class="pill">
            <span class="dot" id="statusDot" style="background:#5cf56f"></span>
            <span id="statusText">VERDE</span>
          </div>
        </div>

        <div class="divider"></div>
        <div class="muted">Fin estimado (cola + reservas + margen)</div>
        <div class="big" id="eta">--:--</div>
        <div class="toast" id="etaExplain"></div>

        <div class="banner" id="colorBanner">
          <strong id="colorTitle">Color</strong>
          <span class="muted" id="colorBody"></span>
        </div>

        <div class="banner" id="adviceBanner">
          <strong id="adviceTitle">Aceptación</strong>
          <span class="muted" id="adviceBody"></span>
        </div>
      </div>

      <div class="card">
        <h2>Acciones</h2>
        <div class="row">
          <button class="btnBase btnPrimary" id="addClient">+ Cliente</button>
          <button class="btnBase btnDanger" id="finishClient">Finalizar</button>
        </div>

        <div class="divider"></div>
        <div class="muted" style="margin-bottom:8px;">Color (paralelo)</div>
        <div class="row">
          <button class="btnBase btnViolet" id="setColorClient">Asignar color…</button>
          <button class="btnBase btnViolet" id="colorWait40">Esperar 40</button>
          <button class="btnBase btnViolet" id="colorWait45">Esperar 45</button>
          <button class="btnBase btnWarn" id="attendColor">Atender color</button>
          <button class="btnBase btnOk" id="resumeClient">Volver al corte</button>
        </div>

        <div class="divider"></div>
        <div class="tiny">
          Si el color vence, tocás <span class="kbd">Atender color</span>: pausa el corte y después volvés.
        </div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Cliente actual</h2>
        <div id="currentBox" class="muted">No hay cliente en curso.</div>
      </div>

      <div class="card">
        <h2>Cola</h2>
        <div class="list" id="queue"></div>
        <div class="toast" id="queueHint"></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Historial del día</h2>
        <div class="list" id="history"></div>
        <div class="right" style="margin-top:10px;">
          <button class="btnBase btnSmall btnPrimary" id="copyHistory">Copiar</button>
          <button class="btnBase btnSmall btnDanger" id="clearHistory">Borrar</button>
        </div>
        <div class="toast">Para comparar con tu cuaderno: nombre + hora + duración + servicio.</div>
      </div>

      <div class="card">
        <h2>Config</h2>
        <div class="grid2">
          <div>
            <div class="muted">Cierre objetivo</div>
            <input type="time" id="shiftEnd" value="22:00" />
          </div>
          <div>
            <div class="muted">Límite duro (min)</div>
            <input type="number" id="hardOver" min="0" max="60" value="10" />
          </div>
          <div>
            <div class="muted">Margen (min)</div>
            <input type="number" id="buffer" min="0" max="60" value="12" />
          </div>
          <div>
            <div class="muted">Pre-alerta color (min)</div>
            <input type="number" id="colorLead" min="1" max="30" value="8" />
          </div>
        </div>

        <div class="divider"></div>
        <div class="right">
          <button class="btnBase btnSmall btnWarn" id="resetData">Reset aprendizaje</button>
          <button class="btnBase btnSmall btnWarn" id="clearDay">Limpiar día</button>
        </div>

        <div class="divider"></div>
        <h2>Aprendizaje</h2>
        <div class="muted" id="stats"></div>
      </div>
    </div>
  </div>

  <dialog id="addDialog">
    <form method="dialog" class="sheet">
      <h2>Nuevo cliente</h2>
      <div class="muted" style="margin-bottom:8px;">Escribí el nombre (con sugerencias).</div>
      <input type="text" id="clientName" list="nameSuggestions" placeholder="Ej: Juan" autocomplete="off" />
      <div class="divider"></div>
      <div class="right">
        <button class="btnBase btnSmall" value="cancel">Cancelar</button>
        <button class="btnBase btnSmall btnPrimary" value="ok">Agregar</button>
      </div>
    </form>
  </dialog>

  <dialog id="finishDialog">
    <form method="dialog" class="sheet">
      <h2>¿Qué hiciste?</h2>
      <div class="muted" id="finishInfo" style="margin-bottom:10px;"></div>

      <div class="grid2">
        <label><input type="checkbox" id="didBeard" /> Barba (navaja)</label>
        <label><input type="checkbox" id="didWash" /> Lavado</label>
        <label><input type="checkbox" id="didBrows" /> Cejas (+3)</label>
        <label><input type="checkbox" id="didDesign" /> Diseño (+3)</label>
      </div>

      <div class="divider"></div>
      <div class="right">
        <button class="btnBase btnSmall" value="cancel">Cancelar</button>
        <button class="btnBase btnSmall btnPrimary" value="ok">Confirmar</button>
      </div>
    </form>
  </dialog>

  <dialog id="colorClientDialog">
    <form method="dialog" class="sheet">
      <h2>¿Quién es el color?</h2>
      <div class="muted" style="margin-bottom:10px;">Elegí un cliente (actual o cola). El color queda en paralelo.</div>
      <select id="colorClientSelect"></select>
      <div class="divider"></div>
      <div class="right">
        <button class="btnBase btnSmall" value="cancel">Cancelar</button>
        <button class="btnBase btnSmall btnViolet" value="ok">Asignar</button>
      </div>
    </form>
  </dialog>

<script>
/* --------- Pulse effect helper --------- */
function pulse(btn){
  if(!btn) return;
  const s=document.createElement('span');
  s.className='pulse';
  btn.appendChild(s);
  setTimeout(()=>{ try{btn.removeChild(s);}catch{} }, 500);
}

/* ===== Tiempo ===== */
function pad(n){ return String(n).padStart(2,'0'); }
function toMin(hhmm){ const [h,m]=hhmm.split(':').map(Number); return h*60+m; }
function fromMin(min){ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=min%60; return pad(h)+':'+pad(m); }
function nowMin(){ const d=new Date(); return d.getHours()*60+d.getMinutes(); }

/* ===== Storage ===== */
const LS_KEY='barber_turnos_pwa_v3_neon';
function load(){ try{return JSON.parse(localStorage.getItem(LS_KEY))||null;}catch{return null;} }
function save(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

/* ===== Learning (EMA) ===== */
function ema(prev, val, a){ if(prev==null) return val; return prev*(1-a)+val*a; }

/* ===== Estado ===== */
const defaultState={
  config:{ shiftEnd:'22:00', hardOver:10, buffer:12, colorLead:8 },
  seq:1,
  current:null,
  queue:[],
  paused:null,
  color:null, // { clientId, clientName, stage:'idle'|'waiting'|'due', dueMin, alertMin, alerted, reservedFinalCut:true }
  history:[],
  knownNames:[],
  learn:{
    baseCut:{ avg:38, n:0 },
    addBeard:{ avg:27, n:0 },
    addWash:{ avg:7, n:0 },
    addBrow:{ avg:3, n:0 },
    addDesign:{ avg:3, n:0 }
  }
};
let state=load()||structuredClone(defaultState);

/* ===== UI ===== */
const elNow=document.getElementById('now');
const elEta=document.getElementById('eta');
const elEtaExplain=document.getElementById('etaExplain');
const elDot=document.getElementById('statusDot');
const elStatus=document.getElementById('statusText');

const elQueue=document.getElementById('queue');
const elQueueHint=document.getElementById('queueHint');
const elCurrentBox=document.getElementById('currentBox');
const elHistory=document.getElementById('history');

const nameSuggestions=document.getElementById('nameSuggestions');

const shiftEnd=document.getElementById('shiftEnd');
const hardOver=document.getElementById('hardOver');
const buffer=document.getElementById('buffer');
const colorLead=document.getElementById('colorLead');

const addClientBtn=document.getElementById('addClient');
const finishClientBtn=document.getElementById('finishClient');
const resetDataBtn=document.getElementById('resetData');
const clearDayBtn=document.getElementById('clearDay');

const setColorClientBtn=document.getElementById('setColorClient');
const colorWait40Btn=document.getElementById('colorWait40');
const colorWait45Btn=document.getElementById('colorWait45');
const attendColorBtn=document.getElementById('attendColor');
const resumeClientBtn=document.getElementById('resumeClient');

const colorBanner=document.getElementById('colorBanner');
const colorTitle=document.getElementById('colorTitle');
const colorBody=document.getElementById('colorBody');

const adviceBanner=document.getElementById('adviceBanner');
const adviceTitle=document.getElementById('adviceTitle');
const adviceBody=document.getElementById('adviceBody');

const addDialog=document.getElementById('addDialog');
const clientNameInput=document.getElementById('clientName');

const finishDialog=document.getElementById('finishDialog');
const finishInfo=document.getElementById('finishInfo');
const didBeard=document.getElementById('didBeard');
const didWash=document.getElementById('didWash');
const didBrows=document.getElementById('didBrows');
const didDesign=document.getElementById('didDesign');

const colorClientDialog=document.getElementById('colorClientDialog');
const colorClientSelect=document.getElementById('colorClientSelect');

const copyHistoryBtn=document.getElementById('copyHistory');
const clearHistoryBtn=document.getElementById('clearHistory');

/* ===== Utilidades ===== */
function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch{} }

function setBanner(el, show, title, body){
  el.style.display = show ? 'block' : 'none';
  if(show){
    if(el===colorBanner){ colorTitle.textContent=title; colorBody.textContent=body; }
    if(el===adviceBanner){ adviceTitle.textContent=title; adviceBody.textContent=body; }
  }
}

function buildNameSuggestions(){
  const base = [
    'Juan','Juana','Julián','Julieta','Jorge','José','Jonatan','Joaquín','Javier',
    'Martín','Matías','Mateo','Marcos','Máximo','Mauro','Miguel',
    'Franco','Federico','Facundo','Fernando',
    'Nicolás','Nahuel','Néstor',
    'Lucas','Luciano','Leandro','Leonel',
    'Agustín','Alejandro','Andrés','Alan',
    'Santiago','Santino','Sebastián','Sergio',
    'Tomás','Thiago','Tobías',
    'Diego','Damián',
    'Pablo','Pedro',
    'Gonzalo','Guido','Germán',
    'Kevin','Brian'
  ];
  const all = Array.from(new Set([ ...base, ...(state.knownNames||[]) ])).sort((a,b)=>a.localeCompare(b));
  nameSuggestions.innerHTML = all.map(n => `<option value="${n}"></option>`).join('');
}

function estMinutes(opts){
  const L=state.learn;
  let t=L.baseCut.avg;
  if(opts?.beard) t+=L.addBeard.avg;
  if(opts?.wash) t+=L.addWash.avg;
  if(opts?.brows) t+=L.addBrow.avg;
  if(opts?.design) t+=L.addDesign.avg;
  return Math.round(t);
}

function getCurrentActiveMin(){
  if(!state.current) return 0;
  const nowM = nowMin();
  const running = state.current.lastResumeMin != null;
  return state.current.activeMin + (running ? Math.max(0, nowM - state.current.lastResumeMin) : 0);
}

function startClient(client){
  const nowM = nowMin();
  state.current = {
    id: client.id,
    name: client.name || '',
    startedAtMin: nowM,
    activeMin: 0,
    lastResumeMin: nowM
  };
}

function startNextIfPossible(){
  if(state.current) return;
  if(state.paused) return;
  if(!state.queue.length) return;
  const next = state.queue.shift();
  startClient(next);
}

function pauseCurrent(reason){
  if(!state.current) return;
  state.current.activeMin = getCurrentActiveMin();
  state.current.lastResumeMin = null;
  state.paused = { ...state.current, pausedReason: reason, pausedAtMin: nowMin() };
}

function resumeCurrent(){
  if(!state.paused) return;
  state.current = { ...state.paused, lastResumeMin: nowMin() };
  state.paused = null;
}

/* ===== Color paralelo ===== */
function updateColorTimers(){
  if(!state.color) return;
  const nowM = nowMin();

  if(state.color.stage==='waiting'){
    if(!state.color.alerted && nowM >= state.color.alertMin){
      state.color.alerted = true;
      vibrate(200);
    }
    if(nowM >= state.color.dueMin){
      state.color.stage = 'due';
      vibrate(400);
    }
  }
}

function colorSafeWindowMin(){
  if(!state.color || state.color.stage!=='waiting') return null;
  return state.color.alertMin;
}

function reserveFinalColorCutMinutes(){
  if(!state.color) return 0;
  if(!state.color.reservedFinalCut) return 0;
  return Math.round(state.learn.baseCut.avg + Number(state.config.buffer));
}

/* ===== ETA ===== */
function etaFinishMin(){
  const nowM = nowMin();
  let t = nowM;

  if(state.current){
    const active = getCurrentActiveMin();
    const remaining = Math.max(1, Math.round(state.learn.baseCut.avg - active));
    t += remaining;
  }
  for(const c of state.queue){
    t += Math.round(state.learn.baseCut.avg);
  }
  t += reserveFinalColorCutMinutes();

  if(state.color && (state.color.stage==='waiting' || state.color.stage==='due')){
    const due = state.color.dueMin;
    if(due != null && due < t){
      t += 10; // bloque típico de “acción color”
    }
  }
  return t;
}

function statusFor(etaMin){
  const end=toMin(state.config.shiftEnd);
  const hard=end + Number(state.config.hardOver);
  const buf=Number(state.config.buffer);
  const etaBuf=etaMin + buf;

  if(etaBuf<=end) return { label:'VERDE', color:'#5cf56f', explain:`Con margen (+${buf}): ${fromMin(etaBuf)} (ok)` };
  if(etaBuf<=hard) return { label:'AMARILLO', color:'#ffd34d', explain:`Con margen (+${buf}): ${fromMin(etaBuf)} (te pasás un poco)` };
  return { label:'ROJO', color:'#ff4e6a', explain:`Con margen (+${buf}): ${fromMin(etaBuf)} (no aceptar)` };
}

function acceptanceAdvice(){
  const nowM = nowMin();
  const buf = Number(state.config.buffer);
  const cutSafe = Math.round(state.learn.baseCut.avg + buf);

  const safeUntil = colorSafeWindowMin();
  if(safeUntil != null){
    const free = safeUntil - nowM;
    if(free <= 0) return { show:true, text:`Hay color por atender pronto. No conviene arrancar un corte ahora.` };
    if(free < cutSafe) return { show:true, text:`Ventana segura antes del color: ${free} min. NO entra un corte seguro (solo retoques).` };
    return { show:true, text:`Ventana segura antes del color: ${free} min. Entra 1 corte rápido si arrancás ya y evitás lavado.` };
  }

  const eta = etaFinishMin();
  const st = statusFor(eta);
  if(st.label==='ROJO') return { show:true, text:`No conviene aceptar más. ${st.explain}` };
  if(st.label==='AMARILLO') return { show:true, text:`Estás justo. ${st.explain}` };
  return { show:true, text:`Podés aceptar. ${st.explain}` };
}

/* ===== Render ===== */
function render(){
  updateColorTimers();
  buildNameSuggestions();

  shiftEnd.value = state.config.shiftEnd;
  hardOver.value = state.config.hardOver;
  buffer.value = state.config.buffer;
  colorLead.value = state.config.colorLead;

  const nowM = nowMin();
  elNow.textContent = fromMin(nowM);

  // Cliente actual
  if(!state.current){
    elCurrentBox.textContent = state.paused
      ? `Cliente pausado: #${state.paused.id} ${state.paused.name||''}`
      : 'No hay cliente en curso.';
  } else {
    const active = getCurrentActiveMin();
    const rem = Math.max(1, Math.round(state.learn.baseCut.avg - active));
    const estEnd = nowM + rem;
    elCurrentBox.innerHTML = `
      <div><strong>#${state.current.id} ${state.current.name||''}</strong></div>
      <div class="muted">Inicio: ${fromMin(state.current.startedAtMin)} · Tiempo activo: ${active} min</div>
      <div class="muted">Restante estimado: ${rem} min · Fin aprox: ${fromMin(estEnd)}</div>
    `;
  }

  // Cola
  elQueue.innerHTML='';
  elQueueHint.textContent = state.queue.length ? '' : 'Cola vacía.';
  state.queue.forEach((c, idx) => {
    const div=document.createElement('div');
    div.className='item';
    div.innerHTML=`
      <div>
        <strong>#${c.id} ${c.name||''}</strong>
        <div class="muted">Estimado: Corte base</div>
      </div>
      <div class="meta">
        <div class="muted">${Math.round(state.learn.baseCut.avg)} min</div>
        <button class="btnBase btnSmall" data-remove="${idx}">Quitar</button>
      </div>`;
    elQueue.appendChild(div);
  });

  // Historial
  elHistory.innerHTML = '';
  if(!state.history.length){
    elHistory.innerHTML = `<div class="muted">Aún no hay registros.</div>`;
  } else {
    for(const h of state.history.slice().reverse()){
      const extras = [
        h.beard?'barba':'',
        h.wash?'lavado':'',
        h.brows?'cejas':'',
        h.design?'diseño':''
      ].filter(Boolean).join(' + ') || 'corte';

      const div=document.createElement('div');
      div.className='item';
      div.innerHTML = `
        <div>
          <strong>${h.name||'(sin nombre)'} · #${h.id}</strong>
          <div class="muted">${fromMin(h.startMin)} → ${fromMin(h.endMin)} · ${h.durationMin} min · ${extras}</div>
        </div>
        <div class="meta">
          <div class="muted">${h.durationMin} min</div>
        </div>
      `;
      elHistory.appendChild(div);
    }
  }

  // ETA + semáforo
  const eta = etaFinishMin();
  elEta.textContent = fromMin(eta);
  const st = statusFor(eta);
  elStatus.textContent = st.label;
  elDot.style.background = st.color;
  elDot.style.boxShadow = `0 0 18px ${st.color}66`;
  elEtaExplain.textContent = st.explain + (state.color?.reservedFinalCut ? ' · Reserva corte final color' : '');

  // Color banner
  if(!state.color){
    setBanner(colorBanner,false);
  } else {
    if(state.color.stage==='idle'){
      setBanner(colorBanner,true, `Color · ${state.color.clientName||''}`, 'Asignado. Cuando empiece la espera, tocá “Esperar 40/45”.');
    }
    if(state.color.stage==='waiting'){
      const remDue = state.color.dueMin - nowM;
      const remAlert = state.color.alertMin - nowM;
      setBanner(colorBanner,true, `Color · ${state.color.clientName||''}`,
        `Espera · Lavar/revisar a las ${fromMin(state.color.dueMin)} (faltan ${Math.max(0,remDue)} min). ` +
        `Pre-alerta ${Math.max(0,remAlert)} min.`
      );
      if(state.color.alerted){
        elStatus.textContent='AMARILLO';
        elDot.style.background='#FFD45A';
        elDot.style.boxShadow='0 0 18px rgba(255,212,90,.55)';
      }
    }
    if(state.color.stage==='due'){
      setBanner(colorBanner,true, `Color · ${state.color.clientName||''}`,
        `YA toca atender el color (debía ser a las ${fromMin(state.color.dueMin)}).`
      );
      elStatus.textContent='ROJO';
      elDot.style.background='#FF4E6A';
      elDot.style.boxShadow='0 0 18px rgba(255,78,106,.55)';
    }
  }

  // Advice banner
  const adv = acceptanceAdvice();
  setBanner(adviceBanner, adv.show, 'Aceptación', adv.text);

  // Stats
  const L=state.learn;
  document.getElementById('stats').innerHTML = `
    <div class="muted">Base corte: <strong>${Math.round(L.baseCut.avg)} min</strong> (n=${L.baseCut.n})</div>
    <div class="muted">Extra barba: <strong>+${Math.round(L.addBeard.avg)} min</strong> (n=${L.addBeard.n})</div>
    <div class="muted">Extra lavado: <strong>+${Math.round(L.addWash.avg)} min</strong> (n=${L.addWash.n})</div>
    <div class="muted">Extra cejas: <strong>+${Math.round(L.addBrow.avg)} min</strong> (n=${L.addBrow.n})</div>
    <div class="muted">Extra diseño: <strong>+${Math.round(L.addDesign.avg)} min</strong> (n=${L.addDesign.n})</div>
  `;

  save(state);
}

/* ===== Handlers ===== */
function bindPulse(){
  const all=document.querySelectorAll('button');
  all.forEach(b=>{
    b.addEventListener('click', ()=>pulse(b), { passive:true });
  });
}

/* Quitar de cola */
elQueue.addEventListener('click', (e) => {
  const btn=e.target.closest('button[data-remove]');
  if(!btn) return;
  const idx=Number(btn.dataset.remove);
  state.queue.splice(idx, 1);
  render();
});

/* Agregar cliente */
addClientBtn.addEventListener('click', () => {
  clientNameInput.value = '';
  addDialog.showModal();
});

addDialog.addEventListener('close', () => {
  if(addDialog.returnValue!=='ok') return;
  const name = (clientNameInput.value || '').trim();
  const id = state.seq++;

  if(name){
    state.knownNames = Array.from(new Set([...(state.knownNames||[]), name]));
  }

  const newClient = { id, name };

  if(!state.current && !state.paused){
    startClient(newClient);
  } else {
    state.queue.push(newClient);
  }
  render();
});

/* Finalizar */
finishClientBtn.addEventListener('click', () => {
  if(!state.current) return;
  didBeard.checked=false; didWash.checked=false; didBrows.checked=false; didDesign.checked=false;
  const active = getCurrentActiveMin();
  finishInfo.textContent = `#${state.current.id} ${state.current.name||''} · Tiempo activo real: ${active} min`;
  finishDialog.showModal();
});

finishDialog.addEventListener('close', () => {
  if(finishDialog.returnValue!=='ok') return;

  const opts={ beard:didBeard.checked, wash:didWash.checked, brows:didBrows.checked, design:didDesign.checked };
  const L=state.learn;

  const elapsed = Math.max(1, getCurrentActiveMin());
  const alphaBase=0.20, alphaExtra=0.25;

  const extrasSum =
    (opts.beard ? L.addBeard.avg : 0) +
    (opts.wash ? L.addWash.avg : 0) +
    (opts.brows ? L.addBrow.avg : 0) +
    (opts.design ? L.addDesign.avg : 0);

  const baseObserved=Math.max(10, elapsed - extrasSum);
  L.baseCut.avg=ema(L.baseCut.avg, baseObserved, alphaBase); L.baseCut.n+=1;

  function updateExtra(key, isOn){
    if(!isOn) return;
    const other =
      (key!=='addBeard' && opts.beard ? L.addBeard.avg : 0) +
      (key!=='addWash'  && opts.wash  ? L.addWash.avg  : 0) +
      (key!=='addBrow'  && opts.brows ? L.addBrow.avg  : 0) +
      (key!=='addDesign'&& opts.design? L.addDesign.avg: 0);
    const extraObserved=Math.max(1, elapsed - baseObserved - other);
    L[key].avg=ema(L[key].avg, extraObserved, alphaExtra); L[key].n+=1;
  }
  updateExtra('addBeard', opts.beard);
  updateExtra('addWash', opts.wash);
  updateExtra('addBrow', opts.brows);
  updateExtra('addDesign', opts.design);

  const startMin = state.current.startedAtMin;
  const endMin = nowMin();

  state.history.push({
    id: state.current.id,
    name: state.current.name||'',
    startMin, endMin,
    durationMin: elapsed,
    ...opts
  });

  state.current = null;
  startNextIfPossible();

  render();
});

/* Config */
function bindConfig(){
  state.config.shiftEnd=shiftEnd.value;
  state.config.hardOver=Number(hardOver.value);
  state.config.buffer=Number(buffer.value);
  state.config.colorLead=Number(colorLead.value);
  render();
}
shiftEnd.addEventListener('change', bindConfig);
hardOver.addEventListener('change', bindConfig);
buffer.addEventListener('change', bindConfig);
colorLead.addEventListener('change', bindConfig);

resetDataBtn.addEventListener('click', () => { state.learn=structuredClone(defaultState.learn); render(); });
clearDayBtn.addEventListener('click', () => { state.current=null; state.paused=null; state.queue=[]; state.color=null; render(); });

copyHistoryBtn.addEventListener('click', async () => {
  const lines = state.history.map(h => {
    const extras = [
      h.beard?'barba':'',
      h.wash?'lavado':'',
      h.brows?'cejas':'',
      h.design?'diseño':''
    ].filter(Boolean).join(' + ') || 'corte';
    return `${fromMin(h.startMin)}-${fromMin(h.endMin)} | ${h.name||'(sin nombre)'} | ${extras} | ${h.durationMin}min`;
  }).join('\n');
  try{ await navigator.clipboard.writeText(lines || ''); vibrate(120); }catch{}
});
clearHistoryBtn.addEventListener('click', () => { state.history=[]; render(); });

/* Color: asignar cliente X */
setColorClientBtn.addEventListener('click', () => {
  const options = [];
  if(state.current) options.push({ key:`cur:${state.current.id}`, id: state.current.id, name: state.current.name||'(sin nombre)' });
  for(const c of state.queue) options.push({ key:`q:${c.id}`, id: c.id, name: c.name||'(sin nombre)' });
  if(!options.length) return;

  colorClientSelect.innerHTML = options.map(o => `<option value="${o.key}">#${o.id} ${o.name}</option>`).join('');
  colorClientDialog.showModal();
});

colorClientDialog.addEventListener('close', () => {
  if(colorClientDialog.returnValue!=='ok') return;
  const v = colorClientSelect.value;
  const id = Number(v.split(':')[1]);

  let name = '';
  if(state.current && state.current.id===id) name = state.current.name||'';
  const q = state.queue.find(x => x.id===id);
  if(q) name = q.name||name;

  state.color = {
    clientId: id,
    clientName: name,
    stage: 'idle',
    dueMin: null,
    alertMin: null,
    alerted: false,
    reservedFinalCut: true
  };
  render();
});

function startColorWait(minutes){
  if(!state.color) return;
  const nowM = nowMin();
  const lead = Number(state.config.colorLead)||8;
  state.color.stage = 'waiting';
  state.color.dueMin = nowM + minutes;
  state.color.alertMin = (nowM + minutes) - lead;
  state.color.alerted = false;
  render();
}
colorWait40Btn.addEventListener('click', () => startColorWait(40));
colorWait45Btn.addEventListener('click', () => startColorWait(45));

/* Atender color: pausa corte actual y resetea el color a idle (vos después elegís nueva espera) */
attendColorBtn.addEventListener('click', () => {
  if(!state.color) return;

  if(state.current){
    pauseCurrent('color');
    state.current = null;
  }

  state.color.stage = 'idle';
  state.color.dueMin = null;
  state.color.alertMin = null;
  state.color.alerted = false;

  vibrate(200);
  render();
});

/* Volver al corte */
resumeClientBtn.addEventListener('click', () => {
  if(!state.paused) return;
  resumeCurrent();
  render();
});

/* Service Worker */
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

/* Tick */
setInterval(render, 8000);
bindPulse();
render();
</script>
</body>
</html>
