<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Turnos">

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <title>Turnos</title>

  <style>
    :root{
      color-scheme: dark;
      --bg:#000;
      --text:#EAF0FF;
      --muted:#9CB0D6;

      --blue:#4EA6FF;
      --red:#FF4E6A;
      --amber:#FFD45A;
      --green:#5CF56F;

      --card: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.08);

      --shadow: 0 18px 46px rgba(0,0,0,.68);
      --inset: inset 0 1px 0 rgba(255,255,255,.07), inset 0 -1px 0 rgba(0,0,0,.55);
      --r: 18px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body{
      margin:0;
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
    }

    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 22px;
      display:flex;
      flex-direction: column;
      gap: 14px;
    }

    .top{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 14px;
      border-radius: var(--r);
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .label{ font-size: 12px; color: var(--muted); }
    .now{ font-size: 30px; font-weight: 900; letter-spacing: -0.03em; line-height: 1.05; }
    .eta{ font-size: 18px; font-weight: 800; }
    .tiny{ font-size: 12px; color: rgba(234,240,255,.72); margin-top: 6px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      box-shadow: var(--inset);
      font-size: 12px;
    }
    .dot{ width:10px; height:10px; border-radius: 999px; display:inline-block; }

    .center{
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px 0;
    }

    .mainBtn{
      width: 260px;
      height: 260px;
      border-radius: 999px;
      position: relative;
      display:grid;
      place-items:center;
      border: 0;
      background: transparent;
      cursor:pointer;
      user-select:none;
      transform: translateZ(0);
    }

    .ring{
      position:absolute;
      inset: 0;
      border-radius: 999px;
      background:
        conic-gradient(var(--ringFill) var(--p), rgba(255,255,255,.06) 0);
      filter: drop-shadow(0 0 18px rgba(78,166,255,.28));
    }
    .ring::after{
      content:"";
      position:absolute;
      inset: 10px;
      border-radius: 999px;
      background: #000;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--inset);
    }

    .core{
      position: relative;
      z-index: 2;
      width: 210px;
      height: 210px;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 46px rgba(0,0,0,.7), var(--inset);
      display:flex;
      flex-direction: column;
      align-items:center;
      justify-content:center;
      gap: 10px;
      text-align:center;
    }

    .core::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: 999px;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05),
        0 0 30px rgba(78,166,255,.22);
      pointer-events:none;
      opacity: .9;
    }

    .actionText{
      font-size: 22px;
      font-weight: 1000;
      letter-spacing: .2px;
    }
    .subText{
      font-size: 12px;
      color: rgba(234,240,255,.78);
      padding: 0 18px;
    }
    .countdown{
      font-size: 34px;
      font-weight: 1000;
      letter-spacing: -0.03em;
      line-height: 1;
    }

    .mainBtn:active .core{ transform: translateY(1px) scale(.995); }

    .bottomRow{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 14px;
      border-radius: var(--r);
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
    }

    .waitBtn{
      width: 84px;
      height: 84px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 14px 36px rgba(0,0,0,.66), var(--inset);
      color: var(--text);
      font-weight: 1000;
      cursor:pointer;
      position: relative;
      flex: 0 0 auto;
    }
    .waitBtn::after{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius: 999px;
      box-shadow: 0 0 18px rgba(78,166,255,.28);
      pointer-events:none;
    }
    .waitBtn:active{ transform: translateY(1px) scale(.995); }

    .queueBox{
      flex:1;
      text-align:right;
    }
    .queueIcons{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      max-width: 280px;
    }
    .person{
      width: 22px;
      height: 22px;
      opacity: .95;
      filter: drop-shadow(0 0 10px rgba(78,166,255,.25));
    }
    .qText{
      font-size: 12px;
      color: rgba(234,240,255,.75);
      margin-top: 6px;
      text-align:right;
    }

    .qList{
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      align-items:stretch;
    }
    .qItem{
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      text-align:left;
    }
    .qItem strong{ display:block; font-size: 13px; margin-bottom: 4px; }
    .qItem .muted{ font-size: 12px; color: rgba(234,240,255,.72); }

    .miniRow{
      display:flex;
      gap: 10px;
      justify-content: space-between;
      align-items:center;
      margin-top: 10px;
    }
    .miniBtn{
      flex: 1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 12px;
      font-weight: 1000;
      box-shadow: var(--inset);
      cursor:pointer;
    }
    .miniBtnBlue{ border-color: rgba(78,166,255,.35); box-shadow: 0 0 18px rgba(78,166,255,.14), var(--inset); }
    .miniBtnRed{ border-color: rgba(255,78,106,.32); box-shadow: 0 0 18px rgba(255,78,106,.12), var(--inset); }
    .miniBtn:active{ transform: translateY(1px); }

    dialog::backdrop{ background: rgba(0,0,0,.70); }
    dialog{ border:0; padding:0; background: transparent; }
    .sheet{
      width: min(520px, calc(100vw - 26px));
      border-radius: 18px;
      background: rgba(0,0,0,.92);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .sheet h3{ margin:0 0 8px; font-size: 16px; }
    .sheet .muted{ color: var(--muted); font-size: 12px; }
    .sheet select{
      width: 100%;
      margin-top: 10px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      border-radius: 14px;
      padding: 12px;
      font-size: 14px;
      outline:none;
      box-shadow: var(--inset);
    }
    .row{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      justify-content:flex-end;
    }
    .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: var(--inset);
    }
    .btnBlue{ border-color: rgba(78,166,255,.38); box-shadow: 0 0 20px rgba(78,166,255,.18), var(--inset); }
    .btnRed{ border-color: rgba(255,78,106,.35); box-shadow: 0 0 20px rgba(255,78,106,.16), var(--inset); }
    .btn:active{ transform: translateY(1px); }

    .hintLine{
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: rgba(234,240,255,.8);
    }

    /* Registro */
    .logList{
      margin-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      max-height: 52vh;
      overflow:auto;
      padding-right: 6px;
    }
    .logItem{
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .logItem strong{ display:block; font-size: 13px; margin-bottom: 4px; }
    .logItem .muted{ font-size: 12px; color: rgba(234,240,255,.72); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="label">Ahora</div>
        <div class="now" id="now">--:--</div>
        <div class="tiny" id="statusLine">—</div>
      </div>

      <div style="text-align:right;">
        <div class="badge">
          <span class="dot" id="dot"></span>
          <span id="statusText">VERDE</span>
        </div>
        <div class="label" style="margin-top:10px;">Salida estimada</div>
        <div class="eta" id="eta">--:--</div>
        <div class="tiny" id="etaExplain"></div>
      </div>
    </div>

    <div class="center">
      <button class="mainBtn" id="mainBtn" aria-label="Iniciar o finalizar">
        <div class="ring" id="ring" style="--p: 0deg; --ringFill: var(--blue);"></div>
        <div class="core">
          <div class="actionText" id="actionText">INICIAR</div>
          <div class="countdown" id="countdown">—</div>
          <div class="subText" id="subText">Tocá para arrancar.</div>
        </div>
      </button>
    </div>

    <div class="bottomRow">
      <button class="waitBtn" id="waitBtn">ESPERA</button>

      <div class="queueBox">
        <div class="queueIcons" id="queueIcons"></div>
        <div class="qText" id="qText">0 en espera</div>
        <div class="qList" id="qList"></div>
      </div>
    </div>

    <div class="miniRow">
      <button class="miniBtn miniBtnRed" id="undoBtn">DESHACER</button>
      <button class="miniBtn miniBtnBlue" id="logBtn">REGISTRO</button>
    </div>
  </div>

  <!-- Modal: iniciar (solo servicio) -->
  <dialog id="startDlg">
    <form method="dialog" class="sheet">
      <h3>Iniciar</h3>
      <div class="muted">Elegí el servicio.</div>

      <select id="startService">
        <option value="cut">Corte</option>
        <option value="cutbeard">Corte + Barba</option>
        <option value="cutthermal">Corte + Sellado térmico</option>
        <option value="cutbeardthermal">Corte + Barba + Sellado térmico</option>
        <option value="color">Color</option>
        <option value="perm">Permanente</option>
      </select>

      <div class="row">
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn btnBlue" value="ok">Arrancar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: finalizar (permite corregir servicio real) -->
  <dialog id="finishDlg">
    <form method="dialog" class="sheet">
      <h3>Finalizar</h3>
      <div class="muted" id="finishInfo">—</div>

      <select id="finishService">
        <option value="cut">Corte</option>
        <option value="cutbeard">Corte + Barba</option>
        <option value="cutthermal">Corte + Sellado térmico</option>
        <option value="cutbeardthermal">Corte + Barba + Sellado térmico</option>
        <option value="color">Color</option>
        <option value="perm">Permanente</option>
      </select>

      <div class="row">
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn btnRed" value="ok">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: espera -->
  <dialog id="waitDlg">
    <form method="dialog" class="sheet">
      <h3>Espera</h3>
      <div class="muted" id="waitInfo">—</div>

      <select id="waitService">
        <option value="cut">Corte</option>
        <option value="cutbeard">Corte + Barba</option>
        <option value="cutthermal">Corte + Sellado térmico</option>
        <option value="cutbeardthermal">Corte + Barba + Sellado térmico</option>
        <option value="color">Color</option>
        <option value="perm">Permanente</option>
      </select>

      <div class="hintLine" id="waitHint">—</div>

      <div class="row">
        <button class="btn" value="cancel">No se queda</button>
        <button class="btn btnBlue" value="ok" id="waitOkBtn">Agregar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: confirmación por pasarse de horario -->
  <dialog id="overDlg">
    <form method="dialog" class="sheet">
      <h3>Se pasa del cierre</h3>
      <div class="muted" id="overText">—</div>
      <div class="row">
        <button class="btn" value="cancel">No</button>
        <button class="btn btnRed" value="ok">Aceptar igual</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: registro -->
  <dialog id="logDlg">
    <form method="dialog" class="sheet">
      <h3>Registro del día</h3>
      <div class="muted" id="logSummary">—</div>

      <div class="logList" id="logList"></div>

      <div class="row">
        <button class="btn" value="cancel">Cerrar</button>
        <button class="btn btnBlue" id="copyBtn" value="noop">Copiar</button>
        <button class="btn btnRed" id="clearBtn" value="noop">Borrar</button>
      </div>
    </form>
  </dialog>

<script>
/* ===== Tiempo helpers ===== */
const pad = n => String(n).padStart(2,'0');
const nowMin = () => { const d=new Date(); return d.getHours()*60+d.getMinutes(); }
const fromMin = (m) => { m=((m%1440)+1440)%1440; return pad(Math.floor(m/60))+':'+pad(m%60); }
const toMin = (hhmm) => { const [h,m]=hhmm.split(':').map(Number); return h*60+m; }

const LS='turnos_minimal_v4';
const load=()=>{ try{return JSON.parse(localStorage.getItem(LS))||null}catch{return null} };
const save=(s)=>localStorage.setItem(LS, JSON.stringify(s));

/* ===== Estado ===== */
const defaultState={
  cfg:{
    shiftEnd:'22:00',
    hardOver:10,  // como máximo aceptar hasta 22:10
    buffer:12     // margen semáforo
  },
  seq:1,
  current:null, // {id, startedAtMin, activeMin, lastResumeMin, service}
  queue:[],     // [{id, service}]
  log:[],
  learning:{
    cutAvg:38,
    beardExtra:18,
    thermalExtra:22,
    // Conservadores (por ahora NO usan tiempos muertos):
    // Color: depende mucho; acá lo ponemos alto a propósito.
    colorBlock:210,
    // Permanente: ~60 aplicar + 50 espera + 30 neutralizado/esperas + 10 lavados + corte(38) ~= ~188
    permBlock:190
  }
};
let state = load() || structuredClone(defaultState);

/* ===== UI refs ===== */
const elNow=document.getElementById('now');
const elEta=document.getElementById('eta');
const elEtaExplain=document.getElementById('etaExplain');
const elStatusText=document.getElementById('statusText');
const elDot=document.getElementById('dot');
const elStatusLine=document.getElementById('statusLine');

const mainBtn=document.getElementById('mainBtn');
const actionText=document.getElementById('actionText');
const countdown=document.getElementById('countdown');
const subText=document.getElementById('subText');
const ring=document.getElementById('ring');

const waitBtn=document.getElementById('waitBtn');
const queueIcons=document.getElementById('queueIcons');
const qText=document.getElementById('qText');
const qList=document.getElementById('qList');

const undoBtn=document.getElementById('undoBtn');
const logBtn=document.getElementById('logBtn');

const startDlg=document.getElementById('startDlg');
const startService=document.getElementById('startService');

const finishDlg=document.getElementById('finishDlg');
const finishInfo=document.getElementById('finishInfo');
const finishService=document.getElementById('finishService');

const waitDlg=document.getElementById('waitDlg');
const waitInfo=document.getElementById('waitInfo');
const waitService=document.getElementById('waitService');
const waitHint=document.getElementById('waitHint');
const waitOkBtn=document.getElementById('waitOkBtn');

const overDlg=document.getElementById('overDlg');
const overText=document.getElementById('overText');

const logDlg=document.getElementById('logDlg');
const logSummary=document.getElementById('logSummary');
const logList=document.getElementById('logList');
const copyBtn=document.getElementById('copyBtn');
const clearBtn=document.getElementById('clearBtn');

function vibrate(ms){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch{} }

/* ===== Servicios ===== */
const svcLabel = {
  cut: 'Corte',
  cutbeard: 'Corte + Barba',
  cutthermal: 'Corte + Sellado térmico',
  cutbeardthermal: 'Corte + Barba + Sellado térmico',
  color: 'Color',
  perm: 'Permanente'
};

function estFor(service){
  const L = state.learning;
  const base = L.cutAvg;
  switch(service){
    case 'cut': return Math.round(base);
    case 'cutbeard': return Math.round(base + L.beardExtra);
    case 'cutthermal': return Math.round(base + L.thermalExtra);
    case 'cutbeardthermal': return Math.round(base + L.beardExtra + L.thermalExtra);
    case 'color': return Math.round(L.colorBlock);
    case 'perm': return Math.round(L.permBlock);
    default: return Math.round(base);
  }
}

/* ===== Cliente actual ===== */
function currentActiveMin(){
  if(!state.current) return 0;
  const now=nowMin();
  return state.current.activeMin + Math.max(0, now - (state.current.lastResumeMin ?? now));
}
function currentRemainingMin(){
  if(!state.current) return 0;
  const est = estFor(state.current.service);
  return Math.max(1, est - currentActiveMin());
}

/* ===== Construir schedule (inicio/fin de cada turno) ===== */
function buildSchedule(){
  const now = nowMin();
  let t = now;
  const rows = [];

  if(state.current){
    const rem = currentRemainingMin();
    rows.push({ kind:'current', service: state.current.service, start: state.current.startedAtMin, end: now + rem });
    t = now + rem;
  }
  for(const item of state.queue){
    const dur = estFor(item.service);
    const start = t;
    const end = t + dur;
    rows.push({ kind:'queue', service: item.service, start, end });
    t = end;
  }
  return rows;
}

function etaFinishMin(){
  const sched = buildSchedule();
  if(!sched.length) return nowMin();
  return sched[sched.length - 1].end;
}

/* ===== Semáforo ===== */
function statusFor(eta){
  const end=toMin(state.cfg.shiftEnd);
  const hard=end + state.cfg.hardOver;
  const buf=state.cfg.buffer;
  const etaBuf=eta + buf;

  if(etaBuf<=end) return {label:'VERDE', color:'var(--green)', explain:`Con margen (+${buf}) terminás ${fromMin(etaBuf)}.`};
  if(etaBuf<=hard) return {label:'AMARILLO', color:'var(--amber)', explain:`Te pasás un poco. Con margen: ${fromMin(etaBuf)}.`};
  return {label:'ROJO', color:'var(--red)', explain:`No entra más. Con margen: ${fromMin(etaBuf)}.`};
}

/* ===== UI cola ===== */
function personSvg(){
  return `
  <svg class="person" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M12 12.2c2.4 0 4.3-2 4.3-4.4S14.4 3.4 12 3.4 7.7 5.4 7.7 7.8 9.6 12.2 12 12.2Z"
      stroke="rgba(78,166,255,.95)" stroke-width="1.6"/>
    <path d="M4.6 20.6c.9-4 4-6.2 7.4-6.2s6.5 2.2 7.4 6.2"
      stroke="rgba(78,166,255,.95)" stroke-width="1.6" stroke-linecap="round"/>
  </svg>`;
}

function renderQueue(){
  const n = state.queue.length;

  queueIcons.innerHTML = '';
  for(let i=0;i<Math.min(n,12);i++){
    const wrap=document.createElement('div');
    wrap.innerHTML = personSvg();
    queueIcons.appendChild(wrap.firstElementChild);
  }
  qText.textContent = `${n} en espera`;

  const sched = buildSchedule().filter(x=>x.kind==='queue');
  qList.innerHTML = '';
  for(const s of sched){
    const div=document.createElement('div');
    div.className='qItem';
    div.innerHTML = `<strong>${svcLabel[s.service]}</strong>
      <div class="muted">Inicia ${fromMin(s.start)} · Sale ${fromMin(s.end)}</div>`;
    qList.appendChild(div);
  }
}

/* ===== Ring ===== */
function setRingProgress(pct, running){
  const deg = Math.max(0, Math.min(1, pct)) * 360;
  ring.style.setProperty('--p', `${deg}deg`);
  ring.style.setProperty('--ringFill', running ? 'var(--red)' : 'var(--blue)');
}

/* ===== Registro ===== */
function renderLog(){
  const items = state.log || [];
  const total = items.length;
  const totalMin = items.reduce((a,x)=>a+(x.durationMin||0),0);
  logSummary.textContent = `${total} servicios · ${totalMin} min activos`;

  logList.innerHTML = '';
  if(!items.length){
    logList.innerHTML = `<div class="logItem"><div class="muted">Aún no hay registros.</div></div>`;
    return;
  }
  for(const h of items.slice().reverse()){
    const svc = svcLabel[h.service] || h.service;
    const line = `${fromMin(h.startMin)}-${fromMin(h.endMin)} · ${h.durationMin}m · ${svc}`;
    const div=document.createElement('div');
    div.className='logItem';
    div.innerHTML = `<strong>${svc}</strong><div class="muted">${line}</div>`;
    logList.appendChild(div);
  }
}
function logToText(){
  const items = state.log || [];
  return items.map(h=>{
    const svc = h.service;
    return `${fromMin(h.startMin)}-${fromMin(h.endMin)} | ${svcLabel[svc]||svc} | ${h.durationMin}min`;
  }).join('\n');
}

/* ===== Render ===== */
function render(){
  const now=nowMin();
  elNow.textContent = fromMin(now);

  renderQueue();

  const eta=etaFinishMin();
  elEta.textContent = fromMin(eta);
  const st=statusFor(eta);

  elStatusText.textContent = st.label;
  elDot.style.background = st.color;
  elDot.style.boxShadow = `0 0 18px ${st.color}`;
  elEtaExplain.textContent = st.explain;

  if(!state.current){
    actionText.textContent = 'INICIAR';
    countdown.textContent = '—';
    subText.textContent = state.queue.length
      ? `Hay ${state.queue.length} en espera.`
      : 'Tocá para arrancar.';
    setRingProgress(0, false);
    elStatusLine.textContent = 'Listo.';
  } else {
    actionText.textContent = 'FINALIZAR';
    const rem=currentRemainingMin();
    countdown.textContent = `${rem}m`;
    const fin = now + rem;
    subText.textContent = `Termina aprox ${fromMin(fin)} · ${svcLabel[state.current.service]}`;
    const est = estFor(state.current.service);
    const done = currentActiveMin();
    setRingProgress(done / Math.max(1, est), true);
    elStatusLine.textContent = `En curso · Inicio ${fromMin(state.current.startedAtMin)} · Activo ${done}m`;
  }

  undoBtn.disabled = state.queue.length===0;
  undoBtn.style.opacity = undoBtn.disabled ? 0.45 : 1;

  save(state);
}

/* ===== Acciones ===== */
mainBtn.addEventListener('click', () => {
  if(!state.current){
    startService.value = 'cut';
    startDlg.showModal();
  } else {
    const active = currentActiveMin();
    finishInfo.textContent = `Tiempo activo: ${active} min`;
    finishService.value = state.current.service || 'cut';
    finishDlg.showModal();
  }
});

startDlg.addEventListener('close', () => {
  if(startDlg.returnValue!=='ok') return;

  const service = startService.value || 'cut';
  const now=nowMin();
  state.current = {
    id: state.seq++,
    startedAtMin: now,
    activeMin: 0,
    lastResumeMin: now,
    service
  };
  vibrate(60);
  render();
});

finishDlg.addEventListener('close', () => {
  if(finishDlg.returnValue!=='ok') return;
  if(!state.current) return;

  const done = Math.max(1, currentActiveMin());
  const service = finishService.value || state.current.service || 'cut';

  // Aprendizaje simple SOLO en corte y corte+barba (lo demás lo dejamos fijo)
  const a = 0.22;
  if(service==='cut'){
    state.learning.cutAvg = state.learning.cutAvg*(1-a) + done*a;
  } else if(service==='cutbeard'){
    const baseObs = Math.max(10, done - state.learning.beardExtra);
    state.learning.cutAvg = state.learning.cutAvg*(1-a) + baseObs*a;
    const extraObs = Math.max(5, done - state.learning.cutAvg);
    state.learning.beardExtra = state.learning.beardExtra*(1-a) + extraObs*a;
  }

  // Registro
  const startMin = state.current.startedAtMin;
  const endMin = nowMin();
  state.log.push({ id: state.current.id, service, startMin, endMin, durationMin: done });

  state.current = null;
  vibrate(80);
  render();
});

/* ===== ESPERA + confirmación si pasa de las 22 ===== */
let pendingAdd = null;

function projectedStartEndForNew(service){
  const sched = buildSchedule();
  const lastEnd = sched.length ? sched[sched.length-1].end : nowMin();
  const dur = estFor(service);
  return { start:lastEnd, end:lastEnd + dur, dur };
}

waitBtn.addEventListener('click', () => {
  const rem = state.current ? currentRemainingMin() : 0;
  const fin = state.current ? (nowMin() + rem) : nowMin();
  waitInfo.textContent = state.current
    ? `Te quedan ~${rem} min. Termina aprox ${fromMin(fin)}.`
    : `No hay corte activo. Esto agrega a la cola.`;

  waitService.value = 'cut';
  const p = projectedStartEndForNew(waitService.value);
  waitHint.textContent = `Si lo agregás: inicia ${fromMin(p.start)} · sale ${fromMin(p.end)}.`;
  waitDlg.showModal();
});

waitService.addEventListener('change', () => {
  const p = projectedStartEndForNew(waitService.value);
  waitHint.textContent = `Si lo agregás: inicia ${fromMin(p.start)} · sale ${fromMin(p.end)}.`;
});

waitDlg.addEventListener('close', () => {
  if(waitDlg.returnValue!=='ok') return;

  const service = waitService.value || 'cut';
  const p = projectedStartEndForNew(service);

  const end = toMin(state.cfg.shiftEnd);
  if(p.end > end){
    pendingAdd = { service, p };
    overText.textContent = `Este turno terminaría a ${fromMin(p.end)} (cierre ${state.cfg.shiftEnd}). ¿Aceptar igual?`;
    overDlg.showModal();
    return;
  }

  state.queue.push({ id: state.seq++, service });
  vibrate(80);
  render();
});

overDlg.addEventListener('close', () => {
  if(overDlg.returnValue!=='ok'){
    pendingAdd = null;
    return;
  }
  if(!pendingAdd) return;

  const end = toMin(state.cfg.shiftEnd);
  const hard = end + state.cfg.hardOver;

  // Si se pasa más que 22:10, no lo agregamos (límite duro)
  if(pendingAdd.p.end > hard){
    pendingAdd = null;
    vibrate(120);
    return;
  }

  state.queue.push({ id: state.seq++, service: pendingAdd.service });
  pendingAdd = null;
  vibrate(120);
  render();
});

/* DESHACER */
undoBtn.addEventListener('click', () => {
  if(!state.queue.length) return;
  state.queue.pop();
  vibrate(60);
  render();
});

/* REGISTRO */
logBtn.addEventListener('click', () => {
  renderLog();
  logDlg.showModal();
});

copyBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  const text = logToText();
  try{
    await navigator.clipboard.writeText(text || '');
    vibrate(120);
    copyBtn.textContent = 'Copiado';
    setTimeout(()=>copyBtn.textContent='Copiar', 700);
  }catch{
    copyBtn.textContent = 'No se pudo';
    setTimeout(()=>copyBtn.textContent='Copiar', 900);
  }
});

clearBtn.addEventListener('click', (e) => {
  e.preventDefault();
  state.log = [];
  renderLog();
  vibrate(120);
  render();
});

/* Tick */
setInterval(render, 2500);

/* Service Worker */
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}

render();
</script>
</body>
</html>
